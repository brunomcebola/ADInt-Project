{% extends 'layout.html' %} {% block content %}
<div style="text-align: right">
  <a href="/logout">
    <button class="ui button primary">Log out</button>
  </a>
</div>

<div class="ui tabular menu">
  <div class="item" data-tab="1"><h2></h2></div>
  <div class="item" data-tab="2"><h2></h2></div>
  <div class="item" data-tab="3"><h2></h2></div>
</div>

<div class="ui tab" data-tab="1"></div>
<div class="ui tab" data-tab="2"></div>
<div class="ui tab" data-tab="3"></div>

<div></div>

<div id="chart">
  <div>
    <canvas></canvas>
  </div>
</div>

<div id="table"></div>

<script>
  let types = ["Personal", "Academic", "Administrative"];

  let base_url = "{{base_url}}";
  let student_id = "{{user_id}}";

  let today = new Date();

  $.ajaxSetup({
    headers: {
      Authorization: "Bearer " + "admin",
      "Access-Control-Allow-Origin": "*",
    },
  });

  function setEvalForm(tabContent, tab_id, activitiesTypes, external_id) {
    $(tabContent.children[2]).remove();
    $(tabContent).append(createEvaluationForm());

    let form = $("#evaluation_form");

    form.form({
      onSuccess: function (event, evalFields) {
        event.preventDefault();

        evalFields.rating = $("#evaluation_form .rating").rating("get rating");
        evalFields.service_id = external_id;
        evalFields.student_id = student_id;

        $.ajax({
          url: `${base_url}/test`,
          type: "POST",
          data: evalFields,
          dataType: "json",
          cors: true,
          secure: true,
          beforeSend: function () {
            form.addClass("loading");
          },
          success: function (data) {
            form.form("clear");
            $("#evaluation_form .rating").rating("set rating", 0);
            $(tabContent.children[2]).remove();
            setActForm(tabContent, tab_id, activitiesTypes);
          },
          complete: function () {
            form.removeClass("loading");
          },
        });
      },
    });

    $("#evaluation_form .rating").rating({
      maxRating: 5,
    });

    $("#evaluation_form #skip").on("click", function () {
      $(tabContent.children[2]).remove();
      setActForm(tabContent, tab_id, activitiesTypes);
    });
  }

  function setActForm(tabContent, tab_id, activitiesTypes) {
    $(tabContent).append(createActivityForm(tab_id, activitiesTypes));

    let form = $(`#activity_form_${tab_id}`);
    let start_time = $(`#activity_form_${tab_id} #start_time`);
    let stop_time = $(`#activity_form_${tab_id} #stop_time`);
    let options = $(`#activity_form_${tab_id} #options`)[0];

    $(`#activity_form_${tab_id} input[type=radio][name=sub_type_id]`).change(function () {
      options.innerHTML = "";
      if (activitiesTypes[this.value - 1].values) {
        options.innerHTML = createOptions(activitiesTypes[this.value - 1].values);
        $(options.children[0]).dropdown();
      }
    });

    start_time.calendar({
      maxDate: new Date(today.getFullYear(), today.getMonth(), today.getDate(), today.getHours(), today.getMinutes()),
    });

    stop_time.calendar({
      maxDate: new Date(today.getFullYear(), today.getMonth(), today.getDate(), today.getHours(), today.getMinutes()),
    });

    form.form({
      fields: {
        start_time: {
          identifier: "start_time",
          rules: [
            {
              type: "empty",
              prompt: "Please enter a start time",
            },
          ],
        },
        stop_time: {
          identifier: "stop_time",
          rules: [
            {
              type: "empty",
              prompt: "Please enter a stop time",
            },
          ],
        },
        sub_type_id: {
          identifier: "sub_type_id",
          rules: [
            {
              type: "checked",
              prompt: "Please select an activity type form the list",
            },
          ],
        },
      },
      inline: true,
      on: "blur",
      onSuccess: function (event, actFields) {
        event.preventDefault();

        actFields.start_time = new Date(actFields.start_time).toISOString();
        actFields.stop_time = new Date(actFields.stop_time).toISOString();
        actFields.student_id = student_id;
        actFields.type_id = tab_id;

        if (activitiesTypes[actFields.sub_type_id - 1].values) {
          actFields.external_id = $(`#activity_form_${tab_id} input[name=external_id]`)[0].value;

          if (!actFields.external_id) {
            $("#error_" + tab_id).removeClass("hidden");

            setTimeout(() => $("#error_" + tab_id).addClass("hidden"), 4000);

            $.toast({
              displayTime: 5000,
              message: `You will see me for 5 seconds.`,
            });

            return;
          }
        }

        $.ajax({
          url: `${base_url}/test`,
          type: "POST",
          data: actFields,
          dataType: "json", // type of response data
          cors: true,
          secure: true,
          beforeSend: function () {
            form.addClass("loading");
          },
          success: function (data) {
            $("#success_" + tab_id).removeClass("hidden");

            form.form("clear");

            setTimeout(() => $("#success_" + tab_id).addClass("hidden"), 4000);

            if (tab_id == 3 && actFields.external_id) {
              setEvalForm(tabContent, tab_id, activitiesTypes, actFields.external_id);
            }
          },
          error: function () {
            $("#error_" + tab_id).removeClass("hidden");

            setTimeout(() => $("#error_" + tab_id).addClass("hidden"), 4000);
          },
          complete: function () {
            form.removeClass("loading");
          },
        });

        options.innerHTML = "";
      },
    });
  }

  function setChart(activities) {
    const labels = ["a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a"];

    const data = {
      labels: labels,
      datasets: [
        {
          label: "Personal",
          backgroundColor: "#6F00FF",
          borderColor: "#6F00FF",
          data: [1,2,3,4,5,6,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2],
        },
        {
          label: "Academic",
          backgroundColor: "#00ABFF",
          borderColor: "#00ABFF",
          data: [1, 11, 6, 3, 21, 31, 46],
        },
        {
          label: "Administrative",
          backgroundColor: "#FF8900",
          borderColor: "#FF8900",
          data: [2, 12, 7, 4, 22, 32, 47],
        },
      ],
    };

    const config = {
      type: "line",
      data: data,
      options: {},
    };

    const myChart = new Chart($("#chart canvas"), config);
  }

  let tabs = $(".tabular.menu .item");

  tabs.tab();

  let testArray = [
    {
      id: 1,
      name: "a",
      values: [
        { id: 1, name: "ola" },
        { id: 2, name: "adeus" },
      ],
    },
    { id: 2, name: "b" },
    {
      id: 3,
      name: "c",
      values: [
        { id: 1, name: "ola" },
        { id: 2, name: "adeus" },
      ],
    },
  ];

  for (let tab_id = 1; tab_id <= tabs.length; tab_id++) {
    tabs[tab_id - 1].children[0].innerHTML = types[tab_id - 1];

    let tabContent = $(`.ui.tab[data-tab=${tab_id}]`)[0];

    setActForm(tabContent, tab_id, testArray);
  }

  setChart();

  var table = $("#table")[0];

  table.innerHTML = generateTable([], 0, 5);
</script>
{% endblock %}
